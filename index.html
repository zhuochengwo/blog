<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhuochengwo.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="生活的点点滴滴">
<meta property="og:type" content="website">
<meta property="og:title" content="程枫的个人博客">
<meta property="og:url" content="https://zhuochengwo.github.io/blog/index.html">
<meta property="og:site_name" content="程枫的个人博客">
<meta property="og:description" content="生活的点点滴滴">
<meta property="og:locale">
<meta property="article:author" content="Chengfeng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://zhuochengwo.github.io/blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>程枫的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程枫的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/08/14/laravel%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95refreshdatabase%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/08/14/laravel%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95refreshdatabase%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">laravel单元测试RefreshDatabase分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-14 22:12:33" itemprop="dateCreated datePublished" datetime="2019-08-14T22:12:33+08:00">2019-08-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B2%E4%BB%A3%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">敲代码</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在编写单元测试时，我们或多或少会使用到数据库，一方面我们需要一个干净的数据库，另一方面我们也需要能方便的回滚/清理掉测试产生的数据。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>在<code>laravel</code>单元测试中，我们可以创建<code>.env.testing</code>，配置测试需要的环境参数。如单独配置一个测试库，在执行<code>phpunit</code>时，<code>laravel</code>会自动切换到这个配置，如果没有则会使用<code>.env</code>的配置。 <code>laravel</code>有提供用于清理数据库中数据的<code>trait</code>，在单元测试的<code>class</code>中就能直接使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">RefreshDatabase</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>  <a target="_blank" rel="noopener" href="https://laravel.com/api/5.8/Illuminate/Foundation/Testing/DatabaseMigrations.html">DatabaseMigration</a></li>
<li>  <a target="_blank" rel="noopener" href="https://laravel.com/api/5.8/Illuminate/Foundation/Testing/DatabaseTransactions.html">DatabaseTransactions</a></li>
<li>  <a target="_blank" rel="noopener" href="https://laravel.com/api/5.8/Illuminate/Foundation/Testing/RefreshDatabase.html">RefreshDatabase</a></li>
</ul>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这几个<code>trait</code>各有优缺点，需要看自己的需要选择。 <code>DatabaseMigration</code>比较简单粗暴，在每个单元测试开始时<code>migrate:fresh</code>创建库表结构，结束时直接使用<code>migrate:rollback</code>回滚了整个测试库，优点是真的干净，缺点就是慢。 <code>DatabaseTransactions</code> 跟 <code>RefreshDatabase</code> 差别不大，都是采用事务回滚的方式，只是<code>RefreshDatabase</code>能提供内存型数据库的支持，本文也主要是分析<code>RefreshDatabase</code>的执行过程。</p>
<h4 id="为什么在test类use相关Trait就能发生作用呢？"><a href="#为什么在test类use相关Trait就能发生作用呢？" class="headerlink" title="为什么在test类use相关Trait就能发生作用呢？"></a>为什么在<code>tes</code>t类<code>use</code>相关<code>Trait</code>就能发生作用呢？</h4><p>追踪<code>TestCase</code>源码，发现在基类<a target="_blank" rel="noopener" href="https://laravel.com/api/5.8/Illuminate/Foundation/Testing/TestCase.html">TestCase</a>中<code>setUpTraits</code>方法会检查框架预定义好的一系列<code>Trait</code>,其中就有我们需要的<code>RefreshDatabase</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUpTraits</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$uses</span> = array_flip(class_uses_recursive(<span class="built_in">static</span>::class));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$uses</span>[RefreshDatabase::class])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;refreshDatabase();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$uses</span>[DatabaseMigrations::class])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;runDatabaseMigrations();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>此段代码在检测到<code>RefreshDatabase</code>后会调用其<code>refreshDatabase</code>方法，在此方法中会调用自己的相关方法，检查<code>migrate</code>是否执行，否则会执行<code>migrate:fresh</code>。然后会调用<code>beforeApplicationDestroyed</code>方法注册一系列回调方法，当中就有最重要的<code>rollback</code>。</p>
<h4 id="RefreshDatabase具体执行了哪些sql呢？"><a href="#RefreshDatabase具体执行了哪些sql呢？" class="headerlink" title="RefreshDatabase具体执行了哪些sql呢？"></a><code>RefreshDatabase</code>具体执行了哪些<code>sql</code>呢？</h4><p>通过<code>laravel</code>通过的事件我们是不能获取到如<code>START TRANSACTION</code>等相关语句是不会出现的。 我们开启<code>MySQL</code>的<code>sql</code>日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL general_log &#x3D; &#39;ON&#39;;</span><br></pre></td></tr></table></figure>

<p>执行<code>phpunit</code>，通过日志可以看到会先执行<code>migrate</code>相关内容，就然后就通过<code>START TRANSACTION</code>开启一个事务，在测试结束后<code>ROLLBACK</code>。 如果执行的需要测试的代码有使用事务，则会通过<code>SAVEPOINT</code> 给子事务标记，如果需要回滚则只会滚到标记点即可。对于其中事务的提交，则因<code>laravel</code>事务处理机制问题，并不会提交，只是标记。 与<code>aa</code>的区别就是，不会在每一个测试开始是都会执行<code>migrate</code>，原因是在第一次执行后，其通过<code>RefreshDatabaseState::$migrated</code>标记已执行<code>migrate</code>，后续的<code>test</code>虽然会执行其<code>refreshDatabase</code>方法，但由于能检测到已经执行就不会再次执行了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">refreshTestDatabase</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//先检查，没有执行migrate则会执行</span></span><br><span class="line">        <span class="keyword">if</span> (! RefreshDatabaseState::<span class="variable">$migrated</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;artisan(<span class="string">&#x27;migrate:fresh&#x27;</span>, [</span><br><span class="line">                <span class="string">&#x27;--drop-views&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;shouldDropViews(),</span><br><span class="line">                <span class="string">&#x27;--drop-types&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;shouldDropTypes(),</span><br><span class="line">            ]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;app[Kernel::class]-&gt;setArtisan(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            RefreshDatabaseState::<span class="variable">$migrated</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;beginDatabaseTransaction();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>而后则只会开启事务</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Begin a database transaction on the testing database.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">beginDatabaseTransaction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$database</span> = <span class="keyword">$this</span>-&gt;app-&gt;make(<span class="string">&#x27;db&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;connectionsToTransact() <span class="keyword">as</span> <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="variable">$connection</span> = <span class="variable">$database</span>-&gt;connection(<span class="variable">$name</span>);</span><br><span class="line">        <span class="variable">$dispatcher</span> = <span class="variable">$connection</span>-&gt;getEventDispatcher();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$connection</span>-&gt;unsetEventDispatcher();</span><br><span class="line">        <span class="variable">$connection</span>-&gt;beginTransaction();</span><br><span class="line">        <span class="variable">$connection</span>-&gt;setEventDispatcher(<span class="variable">$dispatcher</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;beforeApplicationDestroyed(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params"><span class="variable">$database</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;connectionsToTransact() <span class="keyword">as</span> <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="variable">$connection</span> = <span class="variable">$database</span>-&gt;connection(<span class="variable">$name</span>);</span><br><span class="line">            <span class="variable">$dispatcher</span> = <span class="variable">$connection</span>-&gt;getEventDispatcher();</span><br><span class="line"></span><br><span class="line">            <span class="variable">$connection</span>-&gt;unsetEventDispatcher();</span><br><span class="line">            <span class="variable">$connection</span>-&gt;rollback();</span><br><span class="line">            <span class="variable">$connection</span>-&gt;setEventDispatcher(<span class="variable">$dispatcher</span>);</span><br><span class="line">            <span class="variable">$connection</span>-&gt;disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，<code>RefreshDatabase</code>的执行流程大致清晰了。</p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>需要注意的是，因为使用的是事务的方式，如果需要测试的代码中使用了事务，而忘了使用<code>COMMIT</code> ，则是不能在单元测试中发现，因为<code>laravel</code>并不会单独对子事务提交。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/06/26/laradock-workspace%E5%90%AF%E7%94%A8xdebug%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E8%A6%86%E7%9B%96%E7%8E%87%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/06/26/laradock-workspace%E5%90%AF%E7%94%A8xdebug%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E8%A6%86%E7%9B%96%E7%8E%87%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">laradock workspace启用xdebug单元测试覆盖率分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-26 18:18:00" itemprop="dateCreated datePublished" datetime="2019-06-26T18:18:00+08:00">2019-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B2%E4%BB%A3%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">敲代码</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>因为需要做单元测试覆盖率的分析，需要<code>xdebug</code>扩展，之前<code>laradock</code>创建<code>worksapce</code>时是没有安装<code>xdebug</code>的，所以需要重新安装。 修改<code>laradock</code>中<code>.env</code>文件</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WORKSPACE_INSTALL_XDEBUG=true</span><br></pre></td></tr></table></figure>

<p>修改完后重新<code>build</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build workspace</span><br></pre></td></tr></table></figure>

<p>然后我的却没有<code>build</code>成功，报了个错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Err:1 http:&#x2F;&#x2F;ppa.launchpad.net&#x2F;ondrej&#x2F;php&#x2F;ubuntu xenial&#x2F;main amd64 php-xdebug amd64 2.6.0+2.5.5-1+ubuntu16.04.1+deb.sury.org+1</span><br><span class="line">  404  Not Found</span><br><span class="line">E: Failed to fetch http:&#x2F;&#x2F;ppa.launchpad.net&#x2F;ondrej&#x2F;php&#x2F;ubuntu&#x2F;pool&#x2F;main&#x2F;x&#x2F;xdebug&#x2F;php-xdebug_2.6.0+2.5.5-1+ubuntu16.04.1+deb.sury.org+1_amd64.deb  404  Not Found</span><br><span class="line"></span><br><span class="line">E: Unable to fetch some archives, maybe run apt-get update or try with --fix-missing?</span><br><span class="line">ERROR: Service &#39;workspace&#39; failed to build: The command &#39;&#x2F;bin&#x2F;sh -c if [ $&#123;INSTALL_XDEBUG&#125; &#x3D; true ]; then     apt-get install -y php$&#123;LARADOCK_PHP_VERSION&#125;-xdebug &amp;&amp;     sed -i &#39;s&#x2F;^;&#x2F;&#x2F;g&#39; &#x2F;etc&#x2F;php&#x2F;$&#123;LARADOCK_PHP_VERSION&#125;&#x2F;cli&#x2F;conf.d&#x2F;20-xdebug.ini &amp;&amp;     echo &quot;alias phpunit&#x3D;&#39;php -dzend_extension&#x3D;xdebug.so &#x2F;var&#x2F;www&#x2F;vendor&#x2F;bin&#x2F;phpunit&#39;&quot; &gt;&gt; ~&#x2F;.bashrc ;fi&#39; returned a non-zero code: 100</span><br></pre></td></tr></table></figure>

<p>这个问题是因为源失效了。 修改<code>laradock/workspace/Dockerfile</code>文件中<strong>261</strong>行原<code>apt-get install -y php$&#123;LARADOCK_PHP_VERSION&#125;-xdebug &amp;&amp; \</code> 为 <code>apt-get update &amp;&amp; apt-get install -y php$&#123;LARADOCK_PHP_VERSION&#125;-xdebug &amp;&amp; \</code> 以下是正确配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RUN if [ $&#123;INSTALL_XDEBUG&#125; = true ]; then \</span><br><span class="line">    # Load the xdebug extension <span class="keyword">only</span> with phpunit commands</span><br><span class="line">    apt-<span class="built_in">get</span> <span class="keyword">update</span> &amp;&amp; apt-<span class="built_in">get</span> install -<span class="keyword">y</span> php$&#123;LARADOCK_PHP_VERSION&#125;-xdebug &amp;&amp; \</span><br><span class="line">    sed -i <span class="string">&#x27;s/^;//g&#x27;</span> /etc/php/$&#123;LARADOCK_PHP_VERSION&#125;/cli/<span class="keyword">conf</span>.d/<span class="number">20</span>-xdebug.ini &amp;&amp; \</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;alias phpunit=&#x27;php -dzend_extension=xdebug.so /var/www/vendor/bin/phpunit&#x27;&quot;</span> &gt;&gt; ~/.bashrc \</span><br><span class="line">;fi</span><br></pre></td></tr></table></figure>

<p>更多信息可以关注<code>laradock</code>的<code>issue</code>：<a target="_blank" rel="noopener" href="https://github.com/laradock/laradock/issues/1847">issue#1847</a> 改完以后就能成功创建了。 然后重启容器 <code>docker-compose up -d workspace</code>，进入<code>workspace</code>容器通过<code>php -m grep xdebug</code>能看到<code>xdenug</code>正常安装了。 通过<code>phpunit --coverage-html ./tests/codeCoverage</code>输出单元测试覆盖率的分析结构，可以通过浏览器打开查看，也可以自行修改<code>./tests/codeCoverage</code>结果输出目录。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/06/26/%E8%A7%A3%E5%86%B3laravel%E4%BF%AE%E6%94%B9phpredis%E5%AF%BC%E8%87%B4travis-ci%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/06/26/%E8%A7%A3%E5%86%B3laravel%E4%BF%AE%E6%94%B9phpredis%E5%AF%BC%E8%87%B4travis-ci%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">解决Laravel修改phpredis导致travis-ci失败的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-26 14:56:09" itemprop="dateCreated datePublished" datetime="2019-06-26T14:56:09+08:00">2019-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B2%E4%BB%A3%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">敲代码</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Travis-ci/" itemprop="url" rel="index"><span itemprop="name">Travis-ci</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>Laravel</code>默认使用的是<a target="_blank" rel="noopener" href="https://github.com/nrk/predis">predis</a>这个库来操作<code>Redis</code>的，想把它改成<code>PHP</code>扩展的<code>phpredis</code>，在<code>config/database.php</code>中将<code>client</code>值从<code>predis</code>改成<code>phpredis</code>即可。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;redis&#x27;</span> =&gt; [</span><br><span class="line">        <span class="string">&#x27;client&#x27;</span> =&gt; <span class="string">&#x27;phpredis&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>本地测试一切正常，但是在推送的<code>github</code>后<code>travis-ci</code>却失败了，失败是在<code>composer install</code>后触发<code>dump-autoload</code>是报了一个 <strong><em>Call to undefined method Illuminate\Support\Facades\Redis::connect()</em></strong> 原因是<code>travis-ci</code>环境没有安装<code>phpredis</code>这个扩展。 解决也很简单，修改<code>.travis.yml</code>文件，在<code>install</code>阶段通过<code>pecl</code>来安装<code>phpredis</code>即可。需要注意的是<code>pecl</code>安装<code>phpredis</code>时有两个参数是通过交互界面输入的，我们需要通过管道来输入两个回车让<code>CI</code>继续下去。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">instal<span class="variable">l:</span></span><br><span class="line">  - <span class="keyword">print</span> <span class="string">&quot;\n\n&quot;</span>  pecl install redis</span><br><span class="line">  - composer install</span><br></pre></td></tr></table></figure>

<p>至此，<code>CI</code>就可以成功的继续下去了。 对于<code>travis-ci</code>失败，我们可以通过<code>travis-ci</code>提供的<code>debug</code>模式调试。 在<code>jobs</code>详情界面，在右侧<code>Restart job</code>下方有一个<code>Debug job</code>的按钮，点击后开启debug任务，在下方<code>Job log</code>中会输出一个可以<code>ssh</code>连接的地址</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Preparing <span class="keyword">debug</span> sessions.</span><br><span class="line">Use the following SSH <span class="keyword">command</span> <span class="keyword">to</span> access the interactive debugging environmen<span class="variable">t:</span></span><br><span class="line">ssh xxxx@xxxx</span><br><span class="line">This build <span class="keyword">is</span> running in quiet <span class="keyword">mode</span>. No session output will <span class="keyword">be</span> displayed.</span><br></pre></td></tr></table></figure>

<p>通过ssh连接到虚拟机进行调试，解决完问题后，将相关命令补充到<code>.travis.yml</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/05/14/%E5%AE%BF%E4%B8%BB%E6%9C%BAnginx%E9%85%8D%E5%90%88docker-php-fpm-%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/05/14/%E5%AE%BF%E4%B8%BB%E6%9C%BAnginx%E9%85%8D%E5%90%88docker-php-fpm-%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">宿主机Nginx 配合 Docker php-fpm 遇到的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-05-14 23:45:33" itemprop="dateCreated datePublished" datetime="2019-05-14T23:45:33+08:00">2019-05-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B2%E4%BB%A3%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">敲代码</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天把博客迁移从自己的 <code>GCP</code> 迁移到了朋友的服务器上，开始了寄居生活（这里要感谢朋友的收留）。 这次用 <code>docker</code> 来部署了，确实简单方便好用。 因为朋友的服务器上已经有安装 <code>Nginx</code> 在用，<code>80</code> 端口冲突，没办法使用容器中的 <code>Nginx</code>了。采用的是宿主机的 <code>Nginx</code> 配合容器中的 <code>php-fpm</code> 来使用，其它如 <code>MySQL</code> 、<code>Redis</code> 等也均用 <code>docker-compose</code> 来管理了。 <code>php-fpm</code> 映射 <code>9001:9000</code>，数据库连接 <code>host</code> 注意使用 <code>--link</code> 的名字，<code>Nginx</code> 配置 <code>fastcgi_pass 127.0.0.1:9001</code>，这些都没什么好说的。 配置好后以为一切顺利，没想到跑步起来，访问网站报了个404，查看<code>Nginx</code>日志发现了如下错误： <code>FastCGI sent in stderr: &quot;Primary script unknown&quot; while reading response header from upstream</code> 一头雾水，当然是求助万能的Google了。 原来是<code>Nginx</code>配置<code>fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</code>有问题。因为<code>php-fpm</code>运行在容器中，其中挂载的项目路径是<code>/aaa/bbb/blog:/var/www/blog</code>，这里 <code>$document_root</code>是<code>Nginx</code>中配置的<code>root</code>参数<code>/aaa/bbb/blog</code>与容器中项目路径<code>/var/www/blog</code>不一致就导致这个问题了，将配置修改为 <code>fastcgi_param SCRIPT_FILENAME /var/www/blog/$fastcgi_script_name;</code>即可解决。 <a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000007077122">参考资料</a> 暂时没有发现其它运行的问题，不过有一部分图片没有使用<code>cos</code>保存在原来的服务器还得迁移过来才行，顺便统一上传到<code>cos</code>算了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/04/09/%E4%BB%8Edep-%E8%BF%81%E7%A7%BB%E5%88%B0go-modules/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/04/09/%E4%BB%8Edep-%E8%BF%81%E7%A7%BB%E5%88%B0go-modules/" class="post-title-link" itemprop="url">从dep 迁移到Go Modules</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-09 19:02:58" itemprop="dateCreated datePublished" datetime="2019-04-09T19:02:58+08:00">2019-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B2%E4%BB%A3%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">敲代码</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h3><p>Go的依赖管理一直是被人诟病的，也有非常多的依赖管理工具，我之前一直用的官方的 <code>dep</code>，整体来说没有什么问题，只是项目需放在<code>GOPATH</code>下挺让人讨厌的，给人的感觉就是管的太多。 Go 在 <code>1.11</code> 中加入<code>Go Modules</code>，将会是 <code>Go 1.13</code> 中的默认行为，这也将是未来的Go依赖管理工具，我们也应该积极跟进，拥抱未来。</p>
<h3 id="开启"><a href="#开启" class="headerlink" title="开启"></a>开启</h3><blockquote>
<p>可以用环境变量 GO111MODULE 开启或关闭模块支持，它有三个可选值：off、on、auto，默认值是 auto。 GO111MODULE=off 无模块支持，go 会从 GOPATH 和 vendor 文件夹寻找包。 GO111MODULE=on 模块支持，go 会忽略 GOPATH 和 vendor 文件夹，只根据 go.mod 下载依赖。 GO111MODULE=auto 在 $GOPATH/src 外面且根目录有 go.mod 文件时，开启模块支持。</p>
</blockquote>
<p>在使用模块的时候，<code>GOPATH</code> 是无意义的，不过它还是会把下载的依赖储存在 <code>$GOPATH/pkg/mod</code> 中，也会把 <code>go install</code> 的结果放在 <code>$GOPATH/bin</code> 中。 <strong>我们也可以不用管这个环境变量，默认的<code>auto</code>已经可以满足我们的需求了</strong></p>
<h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><p>我们先进入之前的项目，假设是<code>~/go/src/my_app</code> 在项目目录执行 <code>go mod init</code> 会自动处理依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/go/src/my_app</span><br><span class="line">go mod init my_app <span class="comment">#my_app是项目目录</span></span><br></pre></td></tr></table></figure>

<p>可以看到如下输出</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span>: creating <span class="keyword">new</span> <span class="keyword">go</span>.<span class="keyword">mod</span>: module my_app</span><br><span class="line"><span class="keyword">go</span>: copying requirements from Gopkg.lock</span><br></pre></td></tr></table></figure>

<p>执行完后我们会看到创建了一个<code>go.mod</code>的文件，这里边就是我们项目的所有依赖信息</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module my_app</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="number">1.11</span></span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">   github.<span class="keyword">com</span>/gin-gonic/gin v1.<span class="number">3.0</span></span><br><span class="line">   github.<span class="keyword">com</span>/<span class="keyword">go</span>-ini/ini v1.<span class="number">42.0</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>然后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go mod download</span><br></pre></td></tr></table></figure>

<p>下载所有的依赖内容，这些依赖都会被下载到<code>$GOPATH/pkg/mod</code>中。 接下来你可以删除 <code>Gopkg.lock</code> 和 <code>Gopkg.toml</code> 文件，还有<code>vendor</code>目录，然后提交 <code>go.mod</code> 和 <code>go.sum</code> 文件。 关于<code>go mod</code>更多的使用方式可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go <span class="built_in">help</span> mod</span><br></pre></td></tr></table></figure>

<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>如果之前的项目结构是类似这种结构 . . └── my_app ├── aaa │   ├── bbb │   ├── ccc │   │   ├── code.go │   ├── main.go 那么之前导入包可能就是这样</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;my_app/aaa/ccc/code.go&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用<code>Go Modules</code>后，最外层的目录就可以不需要了，因为不再是用<code>GOPATH</code>了。 所以导入要去掉<code>my_app</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;aaa/ccc/code.go&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>还是早点切换到<code>Go Modules</code>吧，毕竟<code>1.13</code>可就是默认方式了，<code>dep</code>等到时估计都要被淘汰了，Go的依赖管理也该统一了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/03/21/%E4%B8%80%E4%B8%AA%E5%A5%BD%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8Cjson%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/03/21/%E4%B8%80%E4%B8%AA%E5%A5%BD%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8Cjson%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">一个好用的命令行json格式化工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-21 12:29:16" itemprop="dateCreated datePublished" datetime="2019-03-21T12:29:16+08:00">2019-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E4%BA%AB%E5%8F%91%E7%8E%B0/" itemprop="url" rel="index"><span itemprop="name">分享发现</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>日常编码中，我们或多或少的会跟<code>json</code>打交道，一般对于接口返回的<code>json</code>，我们有浏览器的插件来格式化，或者类似<code>postman</code>这类工具也都是支持<code>json</code>格式化的。 我们直接复制的一段<code>json</code>，可能更多的是用一些在线的json格式化的工具来查看，但这样总感觉不是很爽，最近发现了一个命令行的<code>json</code>可视化工具，非常棒。格式化输出结构，支持鼠标操作，查找，展开/折叠等等等等，浏览器插件有的功能都有。 我要介绍的就是 <strong><a target="_blank" rel="noopener" href="https://github.com/antonmedv/fx">fx</a></strong> ，项目在github开源。 <img src="https://camo.githubusercontent.com/b5df8c57792e443a18a56cd9a292b1a101ba2391/68747470733a2f2f6d6564762e696f2f6173736574732f66782e676966" alt="使用效果" title="使用效果"></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>简单的通过 <code>npm</code> 来安装，就可以愉快的开始享受了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g fx</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol>
<li> 复制json内容调用工具 这是我用这个工具用的最多的一种方式，直接复制一段<code>json</code>，命令行执行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&#123;&quot;code&quot;:0,&quot;message&quot;:&quot;success&quot;,&quot;data&quot;:&#123;&quot;user_id&quot;:1,&quot;username&quot;:&quot;hello world&quot;,&quot;email&quot;:&quot;1111@gmail.com&quot;,&quot;gender&quot;:1,&quot;detail&quot;:&#123;&quot;address&quot;:&quot;China&quot;,&quot;people&quot;:[1,2,3,4,5,6]&#125;&#125;&#125;&#x27;</span>  fx</span><br></pre></td></tr></table></figure>

<ol start="2">
<li> 直接打开json文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fx data.json</span><br></pre></td></tr></table></figure>

<ol start="3">
<li> 格式化接口返回内容</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://movie.douban.com/j/search_subjects?<span class="built_in">type</span>=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=50&amp;page_start=0  fx</span><br></pre></td></tr></table></figure>

<p>更多使用方式可以查看<a target="_blank" rel="noopener" href="https://github.com/antonmedv/fx">官方文档</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/03/18/%E6%B4%9E%E7%AE%AB%E4%BD%8E%E9%9F%B3%E5%88%B0%E9%AB%98%E9%9F%B3%E7%9A%84%E4%BD%93%E4%BC%9A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/03/18/%E6%B4%9E%E7%AE%AB%E4%BD%8E%E9%9F%B3%E5%88%B0%E9%AB%98%E9%9F%B3%E7%9A%84%E4%BD%93%E4%BC%9A/" class="post-title-link" itemprop="url">洞箫低音到高音的体会</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-18 23:37:09" itemprop="dateCreated datePublished" datetime="2019-03-18T23:37:09+08:00">2019-03-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E7%94%9F%E6%B4%BB/" itemprop="url" rel="index"><span itemprop="name">生活</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E4%B9%90%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">乐器</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%B4%9E%E7%AE%AB/" itemprop="url" rel="index"><span itemprop="name">洞箫</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>作为一个完全零基础的初学者，萧这个乐器感觉确实有点折磨人，特别是像我这种手指不灵活，气息不稳的人。 学习萧的这段时间，真的让我对 <strong>顿悟</strong> 这个词有了更深入的理解。 写下这篇文章，也是为了记录下我刚刚顿悟了超吹的要领，算是跨过了新的一到坎了，再试急吹就比较容易了，剩下的，就是一步一步练习熟练，把我这僵尸一样的手给练灵活了。 拿到萧第一步是吹响，这一步没什么问题，吹出筒音确实是琢磨了几天，真正的突破，是在某天晚上，突然发现比较平稳的吹响了筒音5，不管我是摇头晃脑也好，坐着站着也罢，都能响，这是我比较深刻的体会到顿悟那种感觉。当你找到了那种感觉后，萧往嘴唇一靠，就能顺利的吹响，其实自己也不知道为什么。就跟拧魔方一个道理，开始是记公式，熟悉了就是种感觉，手指会快过大脑，在大脑还没反应过来的时候，手指已经刷刷刷的拧了好几圈了。简单说就是肌肉记忆。 突破了筒音5后，缓吹阶段的 5 6 7 1 2 3 4 就比较容易了。而后顺序吹出，也能流畅起来，期间只是不断的调整，不断的找感觉，形成肌肉记忆。 我被卡壳的是超吹，这个真的卡了我不少时间，当然也是自己这段时间不够认真吧！还有一点就是我基本都是晚上练（没办法，白天没时间啊）,不敢太用力，怕吵到别人，萧的穿透力还是挺强的，也就一直没能放开。超吹练的时候跟开始练缓吹的时候差不多，不是吹不响，而是不稳定，有时能响，有时不响，或者是响的时候杂音严重，吹口的漏气声不忍直视，想吹个 <code>1 2 3 4 5 6 7</code> 出来都非常吃力。期间也看了网上的一些文章介绍，但一直不得要领，云里雾里，反而消磨了自己的意志，甚至都想放弃。直到今天晚上，看了<a target="_blank" rel="noopener" href="http://www.yueqixuexi.com/dongxiao/jiaocheng/20141017124228.html">这篇文章</a>,试着切换着吹 5 5,不断切换着吹，突然间找到了那种感觉，再来个 5 6 7 1 2 3 4 也能比较流畅的出来了。其实这篇文章我早就看到过，而且不止一次，毕竟网上关于这块的内容不多，但不知道为什么，就是没能找到这种感觉，所以我才有种强烈的 <strong>顿悟</strong> 的感觉。 下边是重点，困扰我的超吹问题，为什么一直没能突破，其实问题也很简单，<strong>之前在超吹练习的时候，嘴唇基本没有变化，也不知道怎么变化，只是加急气流，也不知道怎么缩小口风。在练习缓吹的时候，上唇是压着下唇的，整个嘴唇比较扁平，口风较大，气流斜向下进入吹口，而超吹的时候，需要将双唇稍稍前凸，类似吹口哨时的样子，但幅度要小得多，气流较缓吹时要稍平一点进入吹口</strong>。这时候吹出来的音就比较稳定了。至于具体幅度，以及稍稍到底要稍多少就得靠自己不断去尝试把握了，这就跟烹饪中说的<strong>适量</strong>调料一个道理。 当然，因为每个人的萧都不同，可能吹法上都会有些出入，只有不断的尝试，不断的练习才能找到是个你的那个萧的感觉，也祝愿每个人都能用自己喜欢的乐器吹出自己喜欢的乐曲。 再啰嗦一点，其实大学的时候就想买根萧玩玩，当时是因为《秦时明月》的插曲《飞雪玉花》（好像不少学萧的都是因为这个曲），但一直没有实际行动，直到前段时间，偶然听到了《一生所爱》的洞箫版，真真实实的打动了我，让我下定决心来学了。现在，我基本也是用这首曲练习的，我的要求不高，能把这首曲吹满意了我就心满意足了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/02/26/%E4%B8%80%E4%B8%AA%E5%BE%88%E5%A5%BD%E7%94%A8%E7%9A%84%E6%AD%A3%E5%88%99%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/02/26/%E4%B8%80%E4%B8%AA%E5%BE%88%E5%A5%BD%E7%94%A8%E7%9A%84%E6%AD%A3%E5%88%99%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">一个很好用的正则可视化工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-26 23:29:07" itemprop="dateCreated datePublished" datetime="2019-02-26T23:29:07+08:00">2019-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E4%BA%AB%E5%8F%91%E7%8E%B0/" itemprop="url" rel="index"><span itemprop="name">分享发现</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>正则表达式给人最大的感觉就是难以看懂，看着就让人头疼。 最近发现一个非常实用的在线正则表达式可视化的工具，不管是看别人的还是分析自己写的，都能让逻辑清晰明了 <a target="_blank" rel="noopener" href="https://jex.im/regulex/#!flags=&re=%5E(a%7Cb)*%3F%24">工具地址</a> 比如下面一段正则，是匹配香港的手机号码的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(?:46(?:0[0-6]1[0-2]4[0-57-9])5730(?:626848)[01]707[1-5]929[03-9])\d&#123;4&#125;(?:5(?:[1-59][0-46-9]6[0-4689]7[0-2469])6(?:0[1-9][13-59]\d[268][0-57-9]7[0-79])9(?:0[1-9]1[02-9][2358][0-8][467]\d))\d&#123;5&#125;</span><br></pre></td></tr></table></figure>

<p>工具分析后的结果： <img src="https://blog-1252719385.cos.ap-guangzhou.myqcloud.com/images/hk_phone.png"> 自己去看的话还是挺头疼的，用工具一分析就变得太简单了，看到这个结构有没有一种让人豁然开朗的感觉 如果觉得上边这段正则还不够刺激，再看看下边一段网上找的，比较全面的匹配邮箱的正则表达式（符合 RFC 5322 标准）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(?:[a-z0-9!#$%&amp;&#39;*+&#x2F;&#x3D;?^_&#96;&#123;&#125;~-]+(?:\.[a-z0-9!#$%&amp;&#39;*+&#x2F;&#x3D;?^_&#96;&#123;&#125;~-]+)*&quot;(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]\\[\x01-\x09\x0b\x0c\x0e-\x7f])*&quot;)@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\[(?:(?:25[0-5]2[0-4][0-9][01]?[0-9][0-9]?)\.)&#123;3&#125;(?:25[0-5]2[0-4][0-9][01]?[0-9][0-9]?[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])</span><br></pre></td></tr></table></figure>

<p>这个已经基本没法看了吧，用工具分析出来都比较复杂了，但至少逻辑非常清晰了，这里不贴图了，可以自己去看<a target="_blank" rel="noopener" href="https://jex.im/regulex/#!flags=&re=(%3F%3A%5Ba-z0-9!%23%24%25%26'*%2B%2F%3D%3F%5E_%60%7B%7C%7D~-%5D%2B(%3F%3A%5C.%5Ba-z0-9!%23%24%25%26'*%2B%2F%3D%3F%5E_%60%7B%7C%7D~-%5D%2B)*%7C%22(%3F%3A%5B%5Cx01-%5Cx08%5Cx0b%5Cx0c%5Cx0e-%5Cx1f%5Cx21%5Cx23-%5Cx5b%5Cx5d-%5Cx7f%5D%7C%5C%5C%5B%5Cx01-%5Cx09%5Cx0b%5Cx0c%5Cx0e-%5Cx7f%5D)*%22)%40(%3F%3A(%3F%3A%5Ba-z0-9%5D(%3F%3A%5Ba-z0-9-%5D*%5Ba-z0-9%5D)%3F%5C.)%2B%5Ba-z0-9%5D(%3F%3A%5Ba-z0-9-%5D*%5Ba-z0-9%5D)%3F%7C%5C%5B(%3F%3A(%3F%3A25%5B0-5%5D%7C2%5B0-4%5D%5B0-9%5D%7C%5B01%5D%3F%5B0-9%5D%5B0-9%5D%3F)%5C.)%7B3%7D(%3F%3A25%5B0-5%5D%7C2%5B0-4%5D%5B0-9%5D%7C%5B01%5D%3F%5B0-9%5D%5B0-9%5D%3F%7C%5Ba-z0-9-%5D*%5Ba-z0-9%5D%3A(%3F%3A%5B%5Cx01-%5Cx08%5Cx0b%5Cx0c%5Cx0e-%5Cx1f%5Cx21-%5Cx5a%5Cx53-%5Cx7f%5D%7C%5C%5C%5B%5Cx01-%5Cx09%5Cx0b%5Cx0c%5Cx0e-%5Cx7f%5D)%2B)%5C%5D)">效果</a> 总之,这是一个非常值得收藏的工具。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/01/31/facebook%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95web%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/01/31/facebook%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95web%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/" class="post-title-link" itemprop="url">Facebook第三方登录(web前后端分离)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-31 11:03:40" itemprop="dateCreated datePublished" datetime="2019-01-31T11:03:40+08:00">2019-01-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B2%E4%BB%A3%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">敲代码</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Facebook实现第三方登录，跟google一样，也是比较简单，当然官方文档跟google比就一般般了。 这里整理以<strong>前后端分离</strong>的方式实现Facebook的第三方登录</p>
<h2 id="申请账号"><a href="#申请账号" class="headerlink" title="申请账号"></a>申请账号</h2><p>可以直接在<a target="_blank" rel="noopener" href="https://developers.facebook.com/apps">app控制面板</a>创建应用，跟google差不多。 在控制面板页面&gt;产品 添加一个<code>facebook登录</code>，选择设置进行相关设置即可。 <img src="https://blog-1252719385.cos.ap-guangzhou.myqcloud.com/images/Selection_025.png" alt="设置" title="设置"></p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>1.前端引导用户授权并获取<code>access_token</code> 2.将获取到的<code>access_token</code>提交到后端验证并获取用户信息 3.后端成功验证后，获取用户信息完成系统登录或注册流程</p>
<h2 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h2><p>前端直接使用官方的<a target="_blank" rel="noopener" href="https://developers.facebook.com/docs/javascript">sdk</a>就行了，下边的代码也来自官方示例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// This is called with the results from from FB.getLoginStatus().</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">statusChangeCallback</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;statusChangeCallback&#x27;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(response);</span><br><span class="line">        <span class="comment">// The response object is returned with a status field that lets the</span></span><br><span class="line">        <span class="comment">// app know the current login status of the person.</span></span><br><span class="line">        <span class="comment">// Full docs on the response object can be found in the documentation</span></span><br><span class="line">        <span class="comment">// for FB.getLoginStatus().</span></span><br><span class="line">        <span class="keyword">if</span> (response.status === <span class="string">&#x27;connected&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// Logged into your app and Facebook.</span></span><br><span class="line">            testAPI();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// The person is not logged into your app or we are unable to tell.</span></span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">&#x27;status&#x27;</span>).innerHTML = <span class="string">&#x27;Please log &#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;into this app.&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function is called when someone finishes with the Login</span></span><br><span class="line">    <span class="comment">// Button.  See the onlogin handler attached to it in the sample</span></span><br><span class="line">    <span class="comment">// code below.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkLoginState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        FB.getLoginStatus(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(response);</span><br><span class="line">            statusChangeCallback(response);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.fbAsyncInit = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        FB.init(&#123;</span><br><span class="line">            appId      : <span class="string">&#x27;your appid&#x27;</span>,</span><br><span class="line">            cookie     : <span class="literal">true</span>,  <span class="comment">// enable cookies to allow the server to access</span></span><br><span class="line">                                <span class="comment">// the session</span></span><br><span class="line">            xfbml      : <span class="literal">true</span>,  <span class="comment">// parse social plugins on this page</span></span><br><span class="line">            version    : <span class="string">&#x27;v2.8&#x27;</span> <span class="comment">// use graph api version 2.8</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        FB.getLoginStatus(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">            statusChangeCallback(response);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load the SDK asynchronously</span></span><br><span class="line">    (<span class="function"><span class="keyword">function</span>(<span class="params">d, s, id</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> js, fjs = d.getElementsByTagName(s)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (d.getElementById(id)) <span class="keyword">return</span>;</span><br><span class="line">        js = d.createElement(s); js.id = id;</span><br><span class="line">        js.src = <span class="string">&quot;https://connect.facebook.net/en_US/sdk.js&quot;</span>;</span><br><span class="line">        fjs.parentNode.insertBefore(js, fjs);</span><br><span class="line">    &#125;(<span class="built_in">document</span>, <span class="string">&#x27;script&#x27;</span>, <span class="string">&#x27;facebook-jssdk&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Here we run a very simple test of the Graph API after login is</span></span><br><span class="line">    <span class="comment">// successful.  See statusChangeCallback() for when this call is made.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testAPI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Welcome!  Fetching your information.... &#x27;</span>);</span><br><span class="line">        FB.api(<span class="string">&#x27;/me&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;Successful login for: &#x27;</span> + response.name);</span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">&#x27;status&#x27;</span>).innerHTML =</span><br><span class="line">                <span class="string">&#x27;Thanks for logging in, &#x27;</span> + response.name + <span class="string">&#x27;!&#x27;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;fb:login-button scope=<span class="string">&quot;public_profile,email&quot;</span> onlogin=<span class="string">&quot;checkLoginState();&quot;</span>&gt;</span><br><span class="line">&lt;/fb:login-button&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id=<span class="string">&quot;status&quot;</span>&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>在<code>statusChangeCallback</code>方法中，用户授权后后，在控制台打印出来的<code>response</code>中就有我们需要的<code>access_token</code>了，通过将<code>access_token</code>提交后端验证就可以了。</p>
<h2 id="后端代码（PHP）"><a href="#后端代码（PHP）" class="headerlink" title="后端代码（PHP）"></a>后端代码（PHP）</h2><p>后端可以通过官方包来完成整个验证流程，先验证<code>access_token</code>，在通过<code>access_token</code>获取用户信息。 安装Facebook官方包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require facebook/graph-sdk</span><br></pre></td></tr></table></figure>

<p>以下是laravel框架实现代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$token</span> = request()-&gt;get(<span class="string">&#x27;token&#x27;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$client</span> = <span class="keyword">new</span> Facebook([</span><br><span class="line">        <span class="string">&#x27;app_id&#x27;</span>     =&gt; <span class="string">&#x27;YOUR APP_ID&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;app_secret&#x27;</span> =&gt; <span class="string">&#x27;YOUR APP_SECRET&#x27;</span>,</span><br><span class="line">    ]);</span><br><span class="line">    <span class="variable">$oAuth2Client</span> = <span class="variable">$client</span>-&gt;getOAuth2Client();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$tokenMetadata</span> = <span class="variable">$oAuth2Client</span>-&gt;debugToken(<span class="variable">$token</span>);</span><br><span class="line">    <span class="variable">$tokenMetadata</span>-&gt;validateAppId(<span class="string">&#x27;YOUR APP_ID&#x27;</span>);</span><br><span class="line">    <span class="variable">$tokenMetadata</span>-&gt;validateExpiration();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$res</span> = <span class="variable">$client</span>-&gt;sendRequest(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/me&#x27;</span>,</span><br><span class="line">                                [<span class="string">&#x27;fields&#x27;</span> =&gt; <span class="string">&#x27;id,name,birthday,gender,hometown,email,picture,devices&#x27;</span>], <span class="variable">$token</span>);</span><br><span class="line">    dd(<span class="variable">$res</span>-&gt;getGraphUser());</span><br><span class="line">&#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    dd(<span class="variable">$e</span>-&gt;getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$res-&gt;getGraphUser()</code> 就会获取到所需的用户信息，这里的信息可以在接口参数中指定，具体可以查看相关<a target="_blank" rel="noopener" href="https://developers.facebook.com/docs/graph-api/reference/v2.6/user">接口文档</a> 到这里，整个流程基本上就处理完了。 相关文章： <a target="_blank" rel="noopener" href="https://chengfeng.site/2019/01/29/google%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E5%AE%9E%E7%8E%B0web%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/">Google第三方登录</a> <a target="_blank" rel="noopener" href="https://chengfeng.site/2019/01/30/twitter%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95web%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/">Twitter第三方登录</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zhuochengwo.github.io/blog/2019/01/30/twitter%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95web%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Chengfeng">
      <meta itemprop="description" content="生活的点点滴滴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程枫的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/01/30/twitter%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95web%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/" class="post-title-link" itemprop="url">Twitter第三方登录(web前后端分离)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-30 19:12:47" itemprop="dateCreated datePublished" datetime="2019-01-30T19:12:47+08:00">2019-01-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-15 13:45:28" itemprop="dateModified" datetime="2020-12-15T13:45:28+08:00">2020-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%95%B2%E4%BB%A3%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">敲代码</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Twitter的第三方登录实现相对来说比较糟心，我自己也是翻遍了google前几页的搜索结果，在这里整理一个比较简单的方法实现，希望能对大家有所帮助。</p>
<h2 id="申请开发者账户并创建app"><a href="#申请开发者账户并创建app" class="headerlink" title="申请开发者账户并创建app"></a>申请开发者账户并创建app</h2><p>Twitter的审核还是很麻烦的，申请api的时候需要写一篇小作文，300字左右，创建app还得再写100字左右的描述。 因为我自己的Twitter审核没有通过，这里就不做过多的描述了。 <a target="_blank" rel="noopener" href="https://developer.twitter.com/en/apps">app配置</a>主要注意回调地址和<code>Consumer API keys</code>这些内容</p>
<h2 id="梳理"><a href="#梳理" class="headerlink" title="梳理"></a>梳理</h2><p>Twitter第三方登录<a target="_blank" rel="noopener" href="https://developer.twitter.com/en/docs/twitter-for-websites/log-in-with-twitter/login-in-with-twitter">官方资料</a>就在这里了，说实话感觉写的比较烂，不过也需要大致读一些，了解下整个流程。 总结来说就是以下几步： 1.通过<a target="_blank" rel="noopener" href="https://developer.twitter.com/en/docs/basics/authentication/api-reference/request_token">oauth/request_token</a>接口获取<code>request_token</code>，请求参数中的<code>oauth_callback</code>需要与创建App时填写的<code>Callback URL</code>匹配，<code>request_token</code>中会返回<code>oauth_token</code>和<code>oauth_token_secret</code>，需要保存其中的<code>oauth_token_secret</code>备用。 2.通过得到的<code>request_token</code>中的<code>oauth_token</code>来组装授权链接<code>https://api.twitter.com/oauth/authenticate?oauth_token=上一步得到的oauth_token</code>，跳转并引导用户授权，<a target="_blank" rel="noopener" href="https://developer.twitter.com/en/docs/basics/authentication/api-reference/authenticate">参考</a> 3.用户授权后会回调到<code>oauth_callback</code>填写的地址，并带上两个重要参数<code>oauth_token</code>,<code>oauth_verifier</code> 4.通过<a target="_blank" rel="noopener" href="https://developer.twitter.com/en/docs/basics/authentication/api-reference/access_token">oauth/access_token</a>接口换取<code>access_token</code>，这个接口需要第一步获取的<code>request_token</code>中的<code>oauth_token_secret</code>，以及第三步中的<code>oauth_verifier</code>，得到<code>oauth_token</code>和<code>oauth_token_secret</code> 5.将第4步获取的<code>oauth_token</code>和<code>oauth_token_secret</code>提交后端接口验证，后端接口通过<a target="_blank" rel="noopener" href="https://developer.twitter.com/en/docs/accounts-and-users/manage-account-settings/api-reference/get-account-verify_credentials.html">account/verify_credentials</a>验证token并获取用户信息</p>
<h2 id="前端实现"><a href="#前端实现" class="headerlink" title="前端实现"></a>前端实现</h2><p>前端代码实现上有一个挺好用的库<a target="_blank" rel="noopener" href="https://github.com/jublo/codebird-js">codebird-js</a>，可以直接拿来用,上边涉及到的步骤都有实现 获取<code>request_token</code>并跳转到Twitter的授权页面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span> src=<span class="string">&quot;./codebird.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="keyword">var</span> cb = <span class="keyword">new</span> Codebird();</span><br><span class="line">    cb.setConsumerKey(<span class="string">&quot;consumer_key&quot;</span>, <span class="string">&quot;consumer_secret&quot;</span>);</span><br><span class="line">    cb.__call(<span class="string">&quot;oauth_requestToken&quot;</span>, &#123; <span class="attr">oauth_callback</span>: <span class="string">&quot;回调地址&quot;</span> &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        reply,</span></span></span><br><span class="line"><span class="function"><span class="params">        rate,</span></span></span><br><span class="line"><span class="function"><span class="params">        err</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;error response or timeout exceeded&quot;</span> + err.error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">            <span class="keyword">if</span> (reply.errors &amp;&amp; reply.errors[<span class="string">&quot;415&quot;</span>]) &#123;</span><br><span class="line">                <span class="comment">// check your callback URL</span></span><br><span class="line">                <span class="built_in">console</span>.log(reply.errors[<span class="string">&quot;415&quot;</span>]);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// stores the token</span></span><br><span class="line">            cb.setToken(reply.oauth_token, reply.oauth_token_secret);</span><br><span class="line">            <span class="comment">// gets the authorize screen URL</span></span><br><span class="line">            cb.__call(<span class="string">&quot;oauth_authorize&quot;</span>, &#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">auth_url</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">window</span>.codebird_auth = <span class="built_in">window</span>.open(auth_url);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>用户授权后会跳转到回调页面，get参数带上<code>oauth_token</code>,<code>oauth_verifier</code> 需要在这个页面获取参数完成后续步骤</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cb = <span class="keyword">new</span> Codebird();</span><br><span class="line">    <span class="keyword">var</span> current_url = location.toString();</span><br><span class="line">    <span class="keyword">var</span> query = current_url.match(<span class="regexp">/\?(.+)$/</span>).split(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> parameters = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> parameter;</span><br><span class="line"></span><br><span class="line">    cb.setConsumerKey(<span class="string">&quot;consumer_key&quot;</span>, <span class="string">&quot;consumer_secret&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; query.length; i++) &#123;</span><br><span class="line">        parameter = query[i].split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (parameter.length === <span class="number">1</span>) &#123;</span><br><span class="line">            parameter[<span class="number">1</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        parameters[<span class="built_in">decodeURIComponent</span>(parameter[<span class="number">0</span>])] = <span class="built_in">decodeURIComponent</span>(</span><br><span class="line">            parameter[<span class="number">1</span>]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if oauth_verifier is set</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> parameters.oauth_verifier !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">        cb.setToken(</span><br><span class="line">            stored_somewhere.oauth_token,</span><br><span class="line">            stored_somewhere.oauth_token_secret</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        cb.__call(</span><br><span class="line">            <span class="string">&quot;oauth_accessToken&quot;</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                oauth_verifier: parameters.oauth_verifier</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params">reply, rate, err</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;error response or timeout exceeded&quot;</span> + err.error);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (reply) &#123;</span><br><span class="line">                    cb.setToken(reply.oauth_token, reply.oauth_token_secret);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>后续只需要将<code>oauth_token</code>和<code>oauth_token_secret</code>提交到后端验证即可</p>
<h2 id="后端代码（PHP）"><a href="#后端代码（PHP）" class="headerlink" title="后端代码（PHP）"></a>后端代码（PHP）</h2><p>须先安装第三方库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="keyword">require</span> abraham/twitteroauth</span><br></pre></td></tr></table></figure>

<p>对前端提交的<code>oauth_token</code>和<code>oauth_token_secret</code>验证 以下是<code>laravel</code>框架实现代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$oauth_token</span> = request()-&gt;get(<span class="string">&#x27;oauth_token&#x27;</span>);</span><br><span class="line"><span class="variable">$oauth_token_secret</span> = request()-&gt;get(<span class="string">&#x27;oauth_token_secret&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$client</span> = <span class="keyword">new</span> TwitterOAuth(<span class="string">&#x27;consumer_key&#x27;</span>,<span class="string">&#x27;consumer_secret&#x27;</span>);</span><br><span class="line">    <span class="variable">$client</span>-&gt;setOauthToken(<span class="variable">$oauth_token</span>, <span class="variable">$oauth_token_secret</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="variable">$client</span>-&gt;get(<span class="string">&quot;account/verify_credentials&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    dd(<span class="variable">$e</span>-&gt;getMessage());</span><br><span class="line">&#125;</span><br><span class="line">dd(<span class="variable">$response</span>);</span><br><span class="line"><span class="comment">//response获取到的就是用户信息，可以自行处理后续逻辑</span></span><br></pre></td></tr></table></figure>

<p>至此Twitter第三方登录前后端分离的实现就基本完成了。 同样的<code>Android</code>和<code>iOS</code>都有同样的实现，后端可以提供统一的接口验证token就可以完成整个流程了</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>需要注意的是，这里创建的app的<code>consumer_key</code>和<code>consumer_secret</code>都是暴露出去的，<code>codebird-js</code>这个库的作者是建议将app的设置成<code>read-only</code></p>
<blockquote>
<p>Because the Consumer Key and Token Secret are available in the code, it is important that you configure your app as read-only at Twitter, unless you are sure to know what you are doing.</p>
</blockquote>
<p><code>Android</code>和<code>iOS</code>官方包的实现上也都是两个都需要的，也就是说Twitter官方肯定已经考虑到泄露的问题，从安全性上来说应该是没有问题的，毕竟回调地址是Twitter后台设定的。 相关文章： <a target="_blank" rel="noopener" href="https://chengfeng.site/2019/01/29/google%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E5%AE%9E%E7%8E%B0web%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/">Google第三方登录</a> <a target="_blank" rel="noopener" href="https://chengfeng.site/2019/01/31/facebook%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95web%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/">Facebook第三方登录</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/5/">5</a><a class="extend next" rel="next" href="/blog/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Chengfeng</p>
  <div class="site-description" itemprop="description">生活的点点滴滴</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengfeng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  















  

  

</body>
</html>
